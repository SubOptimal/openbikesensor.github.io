<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.80.0"><link rel=canonical type=text/html href=/docs/software/><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Software | OpenBikeSensor</title><meta property="og:title" content="Software"><meta property="og:description" content="Passing distance measurement for cyclists. Open source, open data, open science."><meta property="og:type" content="website"><meta property="og:url" content="/docs/software/"><meta property="og:site_name" content="OpenBikeSensor"><meta itemprop=name content="Software"><meta itemprop=description content="Passing distance measurement for cyclists. Open source, open data, open science."><meta name=twitter:card content="summary"><meta name=twitter:title content="Software"><meta name=twitter:description content="Passing distance measurement for cyclists. Open source, open data, open science."><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-00000000-0','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=preload href=/scss/main.min.ddc681e582e462e75556f6d1a3140f4948a17e72c2543ee445567d3048eabf6e.css as=style><link href=/scss/main.min.ddc681e582e462e75556f6d1a3140f4948a17e72c2543ee445567d3048eabf6e.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=/js/slider/ideal-image-slider.min.js></script><script src=/js/slider/iis-bullet-nav.js></script><script src=/js/slider/iis-captions.js></script><script src=/js/obs.js></script><link rel=stylesheet href=/css/slider/ideal-image-slider.css><link rel=stylesheet href=/css/slider/themes/default.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/svg+xml sizes=any href=/favicon.svg><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileImage content="/mstile-144x144.png"><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">OpenBikeSensor</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/><span class=active>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/de/>Deutsch</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="print();return false;">Click here to print</a>.</p><p><a href=/docs/software/>Return to the regular view of this page</a>.</p></div><h1 class=title>Software</h1><ul><li>1: <a href=#pg-c5e1fe529f2ff2be7e16d98de9060468>Firmware</a></li><ul><li>1.1: <a href=#pg-6e6702eb42236c263c53cf28d2ce5b52>Architecture</a></li><li>1.2: <a href=#pg-226236cbe2459b8085bcc02bf22e1187>Setup of Development Environment</a></li><li>1.3: <a href=#pg-51331aee17c036ec192377ca955df78c>Coding Guidelines</a></li><li>1.4: <a href=#pg-2df86ca66efc82c707a6685b81577602>Upgrading the Firmware from 0.2.x to 0.3.x</a></li></ul></ul><div class=content></div></div><div class=td-content><h1 id=pg-c5e1fe529f2ff2be7e16d98de9060468>1 - Firmware</h1></div><div class=td-content><h1 id=pg-6e6702eb42236c263c53cf28d2ce5b52>1.1 - Architecture</h1><h1 id=architecture>Architecture</h1><blockquote><p>TODO: Introduction</p></blockquote><p>Board:</p><ul><li><a href=https://github.com/espressif/arduino-esp32>ESP32 by Espressif</a></li></ul><p>Libraries:</p><ul><li><a href=https://github.com/bblanchon/ArduinoJson>ArduinoJson by Benoit Blanchon</a></li><li><a href=https://github.com/rlogiacco/CircularBuffer>CircularBuffer by AgileWare</a></li><li><a href=https://github.com/mikalhart/TinyGPSPlus>TinyGPSPlus by Mikal Hart</a></li><li><a href=https://github.com/ThingPulse/esp8266-oled-ssd1306>SSD1306 by ThingPulse</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-226236cbe2459b8085bcc02bf22e1187>1.2 - Setup of Development Environment</h1><p>Our firmware uses the great <a href=https://platformio.org/>PlatformIO</a> for easy
management of the toolchains and dependencies required when developing an
application for an embedded device. Thanks to this, you are rather free in the
choice of the development environment. Here are some options.</p><div class="alert alert-info" role=alert>We do not support <em>Arduino IDE</em> anymore since we&rsquo;ve switched to PlatformIO.</div><h2 id=vscode>VSCode</h2><p>The easiest way to get started is through the
<a href=https://code.visualstudio.com/>VSCode</a> IDE/Editor by Microsoft. We support it
for the foreseeable future.</p><ol><li>Download and install <a href=https://code.visualstudio.com/>Visual Studio Code</a>.</li><li>Open the <code>open-bike-sensor.code-workspace</code> in the project root.</li><li>Install the recommended extensions (this might take a while, because <a href>Platform.io</a> gets installed) and restart VSCode when required.</li><li>Linux only: Install <code>platformio-udev.rules</code> by <a href=https://docs.platformio.org/en/latest/faq.html#platformio-udev-rules>following this guide</a>.</li><li>Compile the code (Sidebar: <code>üëΩ > Build</code>; Bottom bar: <code>‚úÖ</code>)</li><li>Connect your ESP and upload the code (Sidebar: <code>üëΩ > Upload</code>; Bottom bar: ‚û°Ô∏è)</li></ol><p>Alternatively you can also download the dependencies yourself and install it with the Arduino IDE (see below).</p><h3 id=troubleshooting>Troubleshooting</h3><ul><li><p><strong>Can&rsquo;t upload to device</strong>
You can specify the device port that VS Code should upload to. Duplicate the <code>custom_config.ini.example</code> file to <code>custom_config.ini</code> and set the <code>upload_port</code> there manually. If this option is not set, the upload port will be autodetected which can fail on some systems or might select the wrong device if other devices are plugged in.</p></li><li><p><strong>Compiling the code fails</strong>
Use the <code>Clean</code> command and delete the <code>.pio</code> directory. Compiling the code again should work now. If any errors persist, please create a new issue!</p></li></ul><h2 id=command-line>Command line</h2><ol><li>Install <code>platformio</code> command line tool for your operating system.</li><li>Clone the repository.</li><li>Copy <code>custom_config.ini.example</code> to <code>custom_config.ini</code> and modify it to
contain your upload port (only required if autodetection fails, or you want
to flash via OTA).</li><li>Connect the sensor via USB, or put it into server mode for OTA flashing.</li><li>Run <code>platformio run -t upload</code>. This will compile and upload your firmware.</li></ol><h2 id=clion>CLion</h2><p>Information on this proprietary IDE can be found
<a href=https://www.jetbrains.com/de-de/clion/>here</a>. While it works for now, it is
not officially supported by the OBS team.</p><ol><li>Install <a href=https://docs.platformio.org/en/latest/core/installation.html#installation-methods>PlatformIO Core (CLI)</a>.</li><li>Download and open <a href=https://www.jetbrains.com/de-de/clion/>CLion</a>.</li><li>Install the <a href=https://plugins.jetbrains.com/plugin/13922-platformio-for-clion>PlatformIO for CLion plugin</a>. Open <code>Configure > Plugins</code> in the welcome screen (alternatively <code>Plugins</code> in the preferences) and search for &ldquo;PlatformIO&rdquo; in the <code>Marketplace</code> tab.</li><li>Restart CLion.</li><li>Open the project folder with<code>Open or Import</code> in the welcome screen (alternatively <code>File > Open ...</code> using the menu bar)</li><li>A popup &ldquo;Create CMakeLists.txt?&rdquo; will appear. Select &ldquo;yes&rdquo;.</li><li>Open the CLion preferences and navigate to <code>Build, Execution, Deployment > CMake</code>. Delete the <code>Debug</code> profile and add a new profile. This new profile should automatically have the name <code>esp32dev</code>. Apply these changes and close the preferences.</li><li>Select the configuration <code>PlatformIO Build & Upload | esp32dev</code> in the top bar.</li><li>Use the <code>üî® Build</code> button to compile the code.</li><li>Connect your ESP and use the <code>‚ñ∂ Run</code> button to compile and upload the code. To upload without re-compiling the code, switch to the configuration <code>PlatformIO Only Upload | esp32dev</code> in the top bar.</li></ol><h3 id=troubleshooting-1>Troubleshooting</h3><ul><li><p><strong>Can&rsquo;t upload to device</strong>
You can specify the device port that CLion should upload to. Duplicate the <code>custom_config.ini.example</code> file to <code>custom_config.ini</code> and set the <code>upload_port</code> there manually. If this option is not set, the upload port will be autodetected which can fail on some systems or might select the wrong device if other devices are plugged in.</p></li><li><p><strong>Compiling the code fails</strong>
In the menu bar run/click <code>Tools > PlatformIO > Re-Init</code> and then try to compile the code again. If this didn&rsquo;t fix it delete the directories <code>.pio</code> and <code>cmake-build-*</code>. Compiling the code again should work now. If any errors persist, please create a new issue!</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-51331aee17c036ec192377ca955df78c>1.3 - Coding Guidelines</h1><h2 id=platformioini>platformio.ini</h2><p>The <code>platformio.ini</code> is the main project configuration file.
It configures <a href=https://docs.platformio.org/en/latest/projectconf/section_platformio.html#id4>PlatformIO</a> to build and flash the ESP32</p><h2 id=custom_configini>custom_config.ini</h2><p>PlatformIO supports the option <a href=https://docs.platformio.org/en/latest/projectconf/section_platformio.html>extra_configs</a>,
which allows to include additional configurations. Our <code>platformio.ini</code> is preconfigured a custion configuraion inthe file <code>custom_config.ini</code>.
An example custion configuration file can be found in the root folder of the firmware.</p><h3 id=developer-mode>Developer mode</h3><p>To enable the developer mode, uncomment the following line in the <code>custom_config.ini</code> and flash the firmware:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#c4a000>build_flags</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>-D DEVELOP</span>
</code></pre></div><p>The developer mode enables additional dvelopment options menu in the configuration web interface, where it&rsquo;s possible to configure:</p><ul><li>whether the grid on the display is shown (useful for text debugging)</li><li>whether the WLAN password should be printed to the serial interface (useful for WLAN debugging)</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2df86ca66efc82c707a6685b81577602>1.4 - Upgrading the Firmware from 0.2.x to 0.3.x</h1><p>Da sich das interne Partitionsschema des OpenBikeSensors ge√§ndert hat, ist es f√ºr eine Version kleiner 0.3 notwendig, das Upgrade √ºber den USB-Port durchzuf√ºhren.</p><p>Dazu muss man das Ger√§t aufschrauben und den internen USB-Port mit dem PC per Kabel verbinden.</p><h2 id=vorbereitungen>Vorbereitungen</h2><p>√úber die Weboberfl√§che sollte man die Konfiguration des OpenBikeSensors herunterladen, da diese beim Upgrade zur√ºckgesetzt wird. Das Zur√ºcksetzen passiert nur bei einem Upgrade von &lt;0.3 auf 0.3, bei anderen Upgrades bleibt die Konfiguration erhalten.</p><p>Nach dem Upgrade startet man den OpenBikeSensor entweder ohne angeschlossenes Display oder h√§lt den Best√§tigungsknopf beim Einschalten fest, sodass das Ger√§t einen WLAN-Hotspot startet. Dar√ºber l√§sst sich dann das Backup der Konfiguration wieder auf das Ger√§t hochladen.</p><h2 id=upgrade>Upgrade</h2><h3 id=linux>Linux</h3><p><strong>/dev/ttyUSB0</strong> muss f√ºr den Benutzer beschreibbar sein.</p><h4 id=variante-1-download-und-esptool>Variante 1: Download und Esptool</h4><p>Die aktuelle Firmware kann man <a href=https://github.com/openbikesensor/OpenBikeSensorFirmware/releases>hier herunterladen</a>.</p><p>Dann f√ºhrt man aus:</p><p><code>esptool.py --port /dev/ttyUSB0 write_flash FIXME(Adresse) pfad/zur/firmware.bin</code></p><p>Ausgabe:</p><pre><code>esptool.py v2.8
Serial port /dev/ttyUSB0
Connecting....
Detecting chip type... ESP32
Chip is ESP32D0WDQ6 (revision 1)
Features: WiFi, BT, Dual Core, 240MHz, VRef calibration in efuse, Coding Scheme None
Crystal is 40MHz
MAC: 24:6f:28:a0:c9:18
Uploading stub...
Running stub...
Stub running...
Configuring flash size...
Auto-detected Flash size: 4MB
Compressed 1818864 bytes to 1057296...
Wrote 1818864 bytes (1057296 compressed) at 0x00001000 in 93.4 seconds (effective 155.8 kbit/s)...
Hash of data verified.

Leaving...
Hard resetting via RTS pin...
</code></pre><h4 id=variante-2-git-und-platformio>Variante 2: Git und PlatformIO</h4><p>Git und PlatformIO m√ºssen installiert sein.</p><p>Zuerst klont man das Repo mit der Firmware.</p><p><code>git clone https://github.com/openbikesensor/OpenBikeSensorFirmware.git</code></p><p>Dann wechselt man in das Verzeichnis
<code>cd OpenBikeSensorFirmware</code></p><p>und f√ºhrt das folgende Kommando aus:</p><p><code>platformio run --target upload -e esp32dev</code></p><p>Die Ausgabe sollte so aussehen:</p><pre><code>Processing esp32dev (platform: espressif32; board: esp32dev; framework: arduino)
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Tool Manager: Installing platformio/tool-mkspiffs @ ~2.230.0
Tool Manager: tool-mkspiffs @ 2.230.0 has been installed!
Verbose mode can be enabled via `-v, --verbose` option
CONFIGURATION: https://docs.platformio.org/page/boards/espressif32/esp32dev.html
PLATFORM: Espressif 32 (2.0.0) &gt; Espressif ESP32 Dev Module
HARDWARE: ESP32 240MHz, 320KB RAM, 4MB Flash
DEBUG: Current (esp-prog) External (esp-prog, iot-bus-jtag, jlink, minimodule, olimex-arm-usb-ocd, olimex-arm-usb-ocd-h, olimex-arm-usb-tiny-h, olimex-jtag-tiny, tumpa)
[...]
</code></pre><h3 id=windows>Windows</h3><p>FIXME</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2021 OpenBikeSensor contributors All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js integrity=sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s crossorigin=anonymous></script><script src=/js/main.min.b5fc1b29d2465835844254bd4d804738eaf24c0cec53009b4c6899989be55a47.js integrity="sha256-tfwbKdJGWDWEQlS9TYBHOOryTAzsUwCbTGiZmJvlWkc=" crossorigin=anonymous></script></body></html>